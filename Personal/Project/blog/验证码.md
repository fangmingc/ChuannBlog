## 验证码
- 验证码字符嵌入图片
- 插件-滑块验证码

### 验证码字符嵌入图片
- 效果：
<img src="">

#### 实现
- 使用PIL模块的Image, ImageDraw, ImageFont
- 生成150*40像素的底图，颜色随机
- 生成5位随机字符串（可以是数字，小写字母或大写字母），颜色随机，将字符写进底图
- 生成30个随机点，颜色随机，写进底图
- 生成30个随机圆，颜色随机，写进底图
- 生成5条随机线，颜色随机，写进底图
- 使用io模块的BytesIO，生成文件句柄，放入验证码图，随机字符串放入session中
- 读取验证码图发送至浏览器

#### 代码
- 视图函数

	```python
	def get_valid_code_img(request):
	    """获取验证码"""
	    if request.is_ajax():
	        return HttpResponse("OK")
	    from django.shortcuts import HttpResponse
	    from io import BytesIO
	    from random import randint, choice
	    from PIL import Image, ImageDraw, ImageFont
	
	    def random_color():
	        """生成随机颜色"""
	        return randint(0, 255), randint(0, 255), randint(0, 255)
	
	    # 图片底板
	    width = 150
	    height = 40
	    disturb_num = 30
	    img = Image.new(mode="RGB", size=(width, height), color=random_color())
	    # 画笔
	    draw = ImageDraw.Draw(img, "RGB")
	    # 字体
	    font = ImageFont.truetype("static/fonts/Sofia-Regular.otf", height//2)
	    # draw.text(xy=[0, 20], text="Hello World", fill=random_color())
	    # 画验证码
	    valid_list = []
	    for i in range(6):
	        random_char = choice([str(randint(0, 9)), chr(randint(65, 90)), chr(randint(97, 122))])
	        draw.text([10+i*24, 5], random_char, random_color(), font=font)
	        valid_list.append(random_char)
	
	    # 画随机点
	    for i in range(disturb_num):
	        draw.point((randint(0, width), randint(0, height)), random_color())
	
	    # 画随机圆
	    for i in range(disturb_num):
	        x = randint(0, width)
	        y = randint(0, height)
	        draw.arc((x, y, x + 4, y + 4), 0, 90, random_color())
	
	    # 画随机线
	    for i in range(5):
	        x1 = randint(0, width)
	        y1 = randint(0, height)
	        x2 = randint(0, width)
	        y2 = randint(0, height)
	        draw.line((x1, y1, x2, y2), random_color())
	
	    img_f = BytesIO()
	    img.save(img_f, "png")
	    data = img_f.getvalue()
	    request.session["valid_code"] = "".join(valid_list).upper()
	    return HttpResponse(data)
	```
- 浏览器html及js

	```html
	<div class="row valid_code">
	    <div class="col-md-6">
	        <div class="form-group">
	            <label for="valid_code" class="control-label">验证码</label>
	            <input type="text" id="valid_code" class="form-control" placeholder="请输入验证码">
	        </div>
	    </div>
	    <div class="col-md-6">
	        <img src="/get_valid_code_img/" alt="" width="150px" height="40px" style="margin-top: 20px" id="valid_code_img">
	    </div>
	</div>
	```
	
	```js
	$("#valid_code_img").click(function () {
	    $.ajax({
	        url: "/get_valid_code_img/",
	        type: "GET",
	        success: function (data) {
	            $("#valid_code_img").attr("src", "/get_valid_code_img/")
	        }
	    })
	});
	```

### 插件-滑块验证码
- 效果

#### 实现

#### 代码
- 视图函数

```python
//此为插件附带
from app01.geetest import GeetestLib

pc_geetest_id = "b46d1900d0a894591916ea94ea91bd2c"
pc_geetest_key = "36fc3fe98530eea08dfc6ce76e3d24c4"
def pcgetcaptcha(request):
    user_id = 'test'
    gt = GeetestLib(pc_geetest_id, pc_geetest_key)
    status = gt.pre_process(user_id)
    request.session[gt.GT_STATUS_SESSION_KEY] = status
    request.session["user_id"] = user_id
    response_str = gt.get_response_str()
    return HttpResponse(response_str)


def pcajax_validate(request):
    if request.method == "POST":
        gt = GeetestLib(pc_geetest_id, pc_geetest_key)
        challenge = request.POST.get(gt.FN_CHALLENGE, '')
        validate = request.POST.get(gt.FN_VALIDATE, '')
        seccode = request.POST.get(gt.FN_SECCODE, '')
        status = request.session[gt.GT_STATUS_SESSION_KEY]
        user_id = request.session["user_id"]
        if status:
            result = gt.success_validate(challenge, validate, seccode, user_id)
        else:
            result = gt.failback_validate(challenge, validate, seccode)
        result = {"status": "success"} if result else {"status": "fail"}
        return HttpResponse(json.dumps(result))
    return HttpResponse("error")
```

- 前端js

```
var handlerPopup = function (captchaObj) {
    // 成功的回调
    captchaObj.onSuccess(function () {
        var validate = captchaObj.getValidate();
        $.ajax({
            url: "/pc-geetest/ajax_validate", // 进行二次验证
            type: "post",
            headers: {"X-CSRFToken": $.cookie('csrftoken')},
            dataType: "json",
            data: {
                username: $('#username1').val(),
                password: $('#password1').val(),
                geetest_challenge: validate.geetest_challenge,
                geetest_validate: validate.geetest_validate,
                geetest_seccode: validate.geetest_seccode
            },
            success: function (data) {
                if (data && (data.status === "success")) {
                    location.href = "/index/"
                } else {
                    // $(document.body).html('<h1>登录失败</h1>');
                    alert("认证失败")
                }
            }
        });
    });
    // 登录按钮触发的ajax
    $(".login_btn").click(function () {
        $.ajax({
            url: "/login/",
            type: "POST",
            headers: {"X-CSRFToken": $.cookie('csrftoken')},
            processData: true,
            contentType: "application/json",
            data: JSON.stringify({
                    "username": $("#username").val(),
                    "password": $("#password").val(),
                    "valid_code": $("#valid_code").val()
                }
            ),
            success: function (data){
                data = JSON.parse(data);
                if (!data["username"] && !data["password"]) {
                    // 登录成功进行人机校验
                    captchaObj.show();
                }
                for (var key in data){
                    write_error(key, data[key])
                }
            }
        })
    });
    // 将验证码加到id为captcha的元素里
    captchaObj.appendTo("#popup-captcha");
    // 更多接口参考：http://www.geetest.com/install/sections/idx-client-sdk.html
};

// 验证开始需要向网站主后台获取id，challenge，success（是否启用failback）
$.ajax({
    url: "/pc-geetest/register?t=" + (new Date()).getTime(), // 加随机数防止缓存
    type: "get",
    dataType: "json",
    success: function (data) {
        // 使用initGeetest接口
        // 参数1：配置参数
        // 参数2：回调，回调的第一个参数验证码对象，之后可以使用它做appendTo之类的事件
        initGeetest({
            gt: data.gt,
            challenge: data.challenge,
            product: "popup", // 产品形式，包括：float，embed，popup。注意只对PC版验证码有效
            offline: !data.success // 表示用户后台检测极验服务器是否宕机，一般不需要关注
            // 更多配置参数请参见：http://www.geetest.com/install/sections/idx-client-sdk.html#config
        }, handlerPopup);
    }
});
```



